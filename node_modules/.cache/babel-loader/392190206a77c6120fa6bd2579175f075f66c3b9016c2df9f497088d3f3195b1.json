{"ast":null,"code":"var _jsxFileName = \"D:\\\\PROYECTO DE TESIS A\\xD1O 2026\\\\sistema-armas\\\\frontend\\\\src\\\\context\\\\auth-context.tsx\",\n  _s = $RefreshSig$(),\n  _s2 = $RefreshSig$();\nimport React, { createContext, useContext, useEffect, useMemo, useState } from \"react\";\nimport { http } from \"../api/http\"; // ✅ FIX: import correcto\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst AuthContext = /*#__PURE__*/createContext(null);\nexport function AuthProvider({\n  children\n}) {\n  _s();\n  const [token, setToken] = useState(() => localStorage.getItem(\"token\"));\n  const [user, setUser] = useState(() => {\n    const raw = localStorage.getItem(\"user\");\n    try {\n      return raw ? JSON.parse(raw) : null;\n    } catch {\n      return null;\n    }\n  });\n  const [allowedModules, setAllowedModules] = useState(() => {\n    const raw = localStorage.getItem(\"allowed_modules\");\n    try {\n      return raw ? JSON.parse(raw) : [];\n    } catch {\n      return [];\n    }\n  });\n  const [loading, setLoading] = useState(true);\n  const persistAuth = (t, u, mods) => {\n    localStorage.setItem(\"token\", t);\n    localStorage.setItem(\"user\", JSON.stringify(u));\n    localStorage.setItem(\"allowed_modules\", JSON.stringify(mods));\n    setToken(t);\n    setUser(u);\n    setAllowedModules(mods);\n  };\n  const clearAuth = () => {\n    localStorage.removeItem(\"token\");\n    localStorage.removeItem(\"user\");\n    localStorage.removeItem(\"allowed_modules\");\n    setToken(null);\n    setUser(null);\n    setAllowedModules([]);\n  };\n  const refreshMe = async () => {\n    var _data$allowed_modules;\n    const t = localStorage.getItem(\"token\");\n    if (!t) {\n      clearAuth();\n      return;\n    }\n\n    // ✅ http agrega Authorization con interceptor\n    const {\n      data\n    } = await http.get(\"/auth/me\");\n    const mods = (_data$allowed_modules = data.allowed_modules) !== null && _data$allowed_modules !== void 0 ? _data$allowed_modules : [];\n    localStorage.setItem(\"user\", JSON.stringify(data.user));\n    localStorage.setItem(\"allowed_modules\", JSON.stringify(mods));\n    setUser(data.user);\n    setAllowedModules(mods);\n\n    // ✅ sincroniza token state con localStorage\n    setToken(t);\n  };\n  const login = async (email, password) => {\n    var _data$allowed_modules2;\n    const form = new URLSearchParams();\n    form.append(\"username\", email.trim());\n    form.append(\"password\", password);\n    const {\n      data\n    } = await http.post(\"/auth/login\", form, {\n      headers: {\n        \"Content-Type\": \"application/x-www-form-urlencoded\"\n      }\n    });\n    const mods = (_data$allowed_modules2 = data.allowed_modules) !== null && _data$allowed_modules2 !== void 0 ? _data$allowed_modules2 : [];\n    persistAuth(data.access_token, data.user, mods);\n  };\n  const logout = () => {\n    clearAuth();\n  };\n  useEffect(() => {\n    (async () => {\n      try {\n        if (localStorage.getItem(\"token\")) {\n          await refreshMe();\n        }\n      } catch {\n        clearAuth();\n      } finally {\n        setLoading(false);\n      }\n    })();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n  const value = useMemo(() => ({\n    user,\n    token,\n    allowedModules,\n    loading,\n    isAuthenticated: Boolean(token && user),\n    login,\n    logout,\n    refreshMe\n  }), [user, token, allowedModules, loading]);\n  return /*#__PURE__*/_jsxDEV(AuthContext.Provider, {\n    value: value,\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 148,\n    columnNumber: 10\n  }, this);\n}\n_s(AuthProvider, \"B5DK9ZxOXpTWKtSbsueRtnvF9lQ=\");\n_c = AuthProvider;\nexport function useAuth() {\n  _s2();\n  const ctx = useContext(AuthContext);\n  if (!ctx) throw new Error(\"useAuth must be used within AuthProvider\");\n  return ctx;\n}\n_s2(useAuth, \"/dMy7t63NXD4eYACoT93CePwGrg=\");\nvar _c;\n$RefreshReg$(_c, \"AuthProvider\");","map":{"version":3,"names":["React","createContext","useContext","useEffect","useMemo","useState","http","jsxDEV","_jsxDEV","AuthContext","AuthProvider","children","_s","token","setToken","localStorage","getItem","user","setUser","raw","JSON","parse","allowedModules","setAllowedModules","loading","setLoading","persistAuth","t","u","mods","setItem","stringify","clearAuth","removeItem","refreshMe","_data$allowed_modules","data","get","allowed_modules","login","email","password","_data$allowed_modules2","form","URLSearchParams","append","trim","post","headers","access_token","logout","value","isAuthenticated","Boolean","Provider","fileName","_jsxFileName","lineNumber","columnNumber","_c","useAuth","_s2","ctx","Error","$RefreshReg$"],"sources":["D:/PROYECTO DE TESIS AÑO 2026/sistema-armas/frontend/src/context/auth-context.tsx"],"sourcesContent":["import React, { createContext, useContext, useEffect, useMemo, useState } from \"react\";\r\nimport { http } from \"../api/http\"; // ✅ FIX: import correcto\r\n\r\nexport type Role = \"admin\" | \"operator\";\r\n\r\nexport type User = {\r\n  _id: string;\r\n  email: string;\r\n  name?: string;\r\n  role: Role;\r\n};\r\n\r\ntype AuthMeResponse = {\r\n  user: User;\r\n  allowed_modules: string[];\r\n};\r\n\r\ntype LoginResponse = {\r\n  access_token: string;\r\n  token_type: \"bearer\";\r\n  user: User;\r\n  allowed_modules?: string[];\r\n};\r\n\r\ntype AuthState = {\r\n  user: User | null;\r\n  token: string | null;\r\n  allowedModules: string[];\r\n  isAuthenticated: boolean;\r\n  loading: boolean;\r\n\r\n  login: (email: string, password: string) => Promise<void>;\r\n  logout: () => void;\r\n  refreshMe: () => Promise<void>;\r\n};\r\n\r\nconst AuthContext = createContext<AuthState | null>(null);\r\n\r\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\r\n  const [token, setToken] = useState<string | null>(() => localStorage.getItem(\"token\"));\r\n\r\n  const [user, setUser] = useState<User | null>(() => {\r\n    const raw = localStorage.getItem(\"user\");\r\n    try {\r\n      return raw ? (JSON.parse(raw) as User) : null;\r\n    } catch {\r\n      return null;\r\n    }\r\n  });\r\n\r\n  const [allowedModules, setAllowedModules] = useState<string[]>(() => {\r\n    const raw = localStorage.getItem(\"allowed_modules\");\r\n    try {\r\n      return raw ? (JSON.parse(raw) as string[]) : [];\r\n    } catch {\r\n      return [];\r\n    }\r\n  });\r\n\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  const persistAuth = (t: string, u: User, mods: string[]) => {\r\n    localStorage.setItem(\"token\", t);\r\n    localStorage.setItem(\"user\", JSON.stringify(u));\r\n    localStorage.setItem(\"allowed_modules\", JSON.stringify(mods));\r\n\r\n    setToken(t);\r\n    setUser(u);\r\n    setAllowedModules(mods);\r\n  };\r\n\r\n  const clearAuth = () => {\r\n    localStorage.removeItem(\"token\");\r\n    localStorage.removeItem(\"user\");\r\n    localStorage.removeItem(\"allowed_modules\");\r\n    setToken(null);\r\n    setUser(null);\r\n    setAllowedModules([]);\r\n  };\r\n\r\n  const refreshMe = async () => {\r\n    const t = localStorage.getItem(\"token\");\r\n    if (!t) {\r\n      clearAuth();\r\n      return;\r\n    }\r\n\r\n    // ✅ http agrega Authorization con interceptor\r\n    const { data } = await http.get<AuthMeResponse>(\"/auth/me\");\r\n\r\n    const mods = data.allowed_modules ?? [];\r\n    localStorage.setItem(\"user\", JSON.stringify(data.user));\r\n    localStorage.setItem(\"allowed_modules\", JSON.stringify(mods));\r\n\r\n    setUser(data.user);\r\n    setAllowedModules(mods);\r\n\r\n    // ✅ sincroniza token state con localStorage\r\n    setToken(t);\r\n  };\r\n\r\n  const login = async (email: string, password: string) => {\r\n    const form = new URLSearchParams();\r\n    form.append(\"username\", email.trim());\r\n    form.append(\"password\", password);\r\n\r\n    const { data } = await http.post<LoginResponse>(\"/auth/login\", form, {\r\n      headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\r\n    });\r\n\r\n    const mods = data.allowed_modules ?? [];\r\n    persistAuth(data.access_token, data.user, mods);\r\n  };\r\n\r\n  const logout = () => {\r\n    clearAuth();\r\n  };\r\n\r\n  useEffect(() => {\r\n    (async () => {\r\n      try {\r\n        if (localStorage.getItem(\"token\")) {\r\n          await refreshMe();\r\n        }\r\n      } catch {\r\n        clearAuth();\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    })();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []);\r\n\r\n  const value = useMemo(\r\n    () => ({\r\n      user,\r\n      token,\r\n      allowedModules,\r\n      loading,\r\n      isAuthenticated: Boolean(token && user),\r\n      login,\r\n      logout,\r\n      refreshMe,\r\n    }),\r\n    [user, token, allowedModules, loading]\r\n  );\r\n\r\n  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;\r\n}\r\n\r\nexport function useAuth() {\r\n  const ctx = useContext(AuthContext);\r\n  if (!ctx) throw new Error(\"useAuth must be used within AuthProvider\");\r\n  return ctx;\r\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}