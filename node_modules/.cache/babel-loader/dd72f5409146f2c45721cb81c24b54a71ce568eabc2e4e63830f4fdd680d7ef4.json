{"ast":null,"code":"import React,{createContext,useContext,useEffect,useMemo,useState}from\"react\";import{http}from\"../api/http\";// ✅ FIX: import correcto\nimport{jsx as _jsx}from\"react/jsx-runtime\";const AuthContext=/*#__PURE__*/createContext(null);export function AuthProvider(_ref){let{children}=_ref;const[token,setToken]=useState(()=>localStorage.getItem(\"token\"));const[user,setUser]=useState(()=>{const raw=localStorage.getItem(\"user\");try{return raw?JSON.parse(raw):null;}catch(_unused){return null;}});const[allowedModules,setAllowedModules]=useState(()=>{const raw=localStorage.getItem(\"allowed_modules\");try{return raw?JSON.parse(raw):[];}catch(_unused2){return[];}});const[loading,setLoading]=useState(true);const persistAuth=(t,u,mods)=>{localStorage.setItem(\"token\",t);localStorage.setItem(\"user\",JSON.stringify(u));localStorage.setItem(\"allowed_modules\",JSON.stringify(mods));setToken(t);setUser(u);setAllowedModules(mods);};const clearAuth=()=>{localStorage.removeItem(\"token\");localStorage.removeItem(\"user\");localStorage.removeItem(\"allowed_modules\");setToken(null);setUser(null);setAllowedModules([]);};const refreshMe=async()=>{var _data$allowed_modules;const t=localStorage.getItem(\"token\");if(!t){clearAuth();return;}// ✅ http agrega Authorization con interceptor\nconst{data}=await http.get(\"/auth/me\");const mods=(_data$allowed_modules=data.allowed_modules)!==null&&_data$allowed_modules!==void 0?_data$allowed_modules:[];localStorage.setItem(\"user\",JSON.stringify(data.user));localStorage.setItem(\"allowed_modules\",JSON.stringify(mods));setUser(data.user);setAllowedModules(mods);// ✅ sincroniza token state con localStorage\nsetToken(t);};const login=async(email,password)=>{var _data$allowed_modules2;const form=new URLSearchParams();form.append(\"username\",email.trim());form.append(\"password\",password);const{data}=await http.post(\"/auth/login\",form,{headers:{\"Content-Type\":\"application/x-www-form-urlencoded\"}});const mods=(_data$allowed_modules2=data.allowed_modules)!==null&&_data$allowed_modules2!==void 0?_data$allowed_modules2:[];persistAuth(data.access_token,data.user,mods);};const logout=()=>{clearAuth();};useEffect(()=>{(async()=>{try{if(localStorage.getItem(\"token\")){await refreshMe();}}catch(_unused3){clearAuth();}finally{setLoading(false);}})();// eslint-disable-next-line react-hooks/exhaustive-deps\n},[]);const value=useMemo(()=>({user,token,allowedModules,loading,isAuthenticated:Boolean(token&&user),login,logout,refreshMe}),[user,token,allowedModules,loading]);return/*#__PURE__*/_jsx(AuthContext.Provider,{value:value,children:children});}export function useAuth(){const ctx=useContext(AuthContext);if(!ctx)throw new Error(\"useAuth must be used within AuthProvider\");return ctx;}","map":{"version":3,"names":["React","createContext","useContext","useEffect","useMemo","useState","http","jsx","_jsx","AuthContext","AuthProvider","_ref","children","token","setToken","localStorage","getItem","user","setUser","raw","JSON","parse","_unused","allowedModules","setAllowedModules","_unused2","loading","setLoading","persistAuth","t","u","mods","setItem","stringify","clearAuth","removeItem","refreshMe","_data$allowed_modules","data","get","allowed_modules","login","email","password","_data$allowed_modules2","form","URLSearchParams","append","trim","post","headers","access_token","logout","_unused3","value","isAuthenticated","Boolean","Provider","useAuth","ctx","Error"],"sources":["D:/PROYECTO DE TESIS AÑO 2026/sistema-armas/frontend/src/context/auth-context.tsx"],"sourcesContent":["import React, { createContext, useContext, useEffect, useMemo, useState } from \"react\";\r\nimport { http } from \"../api/http\"; // ✅ FIX: import correcto\r\n\r\nexport type Role = \"admin\" | \"operator\";\r\n\r\nexport type User = {\r\n  _id: string;\r\n  email: string;\r\n  name?: string;\r\n  role: Role;\r\n};\r\n\r\ntype AuthMeResponse = {\r\n  user: User;\r\n  allowed_modules: string[];\r\n};\r\n\r\ntype LoginResponse = {\r\n  access_token: string;\r\n  token_type: \"bearer\";\r\n  user: User;\r\n  allowed_modules?: string[];\r\n};\r\n\r\ntype AuthState = {\r\n  user: User | null;\r\n  token: string | null;\r\n  allowedModules: string[];\r\n  isAuthenticated: boolean;\r\n  loading: boolean;\r\n\r\n  login: (email: string, password: string) => Promise<void>;\r\n  logout: () => void;\r\n  refreshMe: () => Promise<void>;\r\n};\r\n\r\nconst AuthContext = createContext<AuthState | null>(null);\r\n\r\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\r\n  const [token, setToken] = useState<string | null>(() => localStorage.getItem(\"token\"));\r\n\r\n  const [user, setUser] = useState<User | null>(() => {\r\n    const raw = localStorage.getItem(\"user\");\r\n    try {\r\n      return raw ? (JSON.parse(raw) as User) : null;\r\n    } catch {\r\n      return null;\r\n    }\r\n  });\r\n\r\n  const [allowedModules, setAllowedModules] = useState<string[]>(() => {\r\n    const raw = localStorage.getItem(\"allowed_modules\");\r\n    try {\r\n      return raw ? (JSON.parse(raw) as string[]) : [];\r\n    } catch {\r\n      return [];\r\n    }\r\n  });\r\n\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  const persistAuth = (t: string, u: User, mods: string[]) => {\r\n    localStorage.setItem(\"token\", t);\r\n    localStorage.setItem(\"user\", JSON.stringify(u));\r\n    localStorage.setItem(\"allowed_modules\", JSON.stringify(mods));\r\n\r\n    setToken(t);\r\n    setUser(u);\r\n    setAllowedModules(mods);\r\n  };\r\n\r\n  const clearAuth = () => {\r\n    localStorage.removeItem(\"token\");\r\n    localStorage.removeItem(\"user\");\r\n    localStorage.removeItem(\"allowed_modules\");\r\n    setToken(null);\r\n    setUser(null);\r\n    setAllowedModules([]);\r\n  };\r\n\r\n  const refreshMe = async () => {\r\n    const t = localStorage.getItem(\"token\");\r\n    if (!t) {\r\n      clearAuth();\r\n      return;\r\n    }\r\n\r\n    // ✅ http agrega Authorization con interceptor\r\n    const { data } = await http.get<AuthMeResponse>(\"/auth/me\");\r\n\r\n    const mods = data.allowed_modules ?? [];\r\n    localStorage.setItem(\"user\", JSON.stringify(data.user));\r\n    localStorage.setItem(\"allowed_modules\", JSON.stringify(mods));\r\n\r\n    setUser(data.user);\r\n    setAllowedModules(mods);\r\n\r\n    // ✅ sincroniza token state con localStorage\r\n    setToken(t);\r\n  };\r\n\r\n  const login = async (email: string, password: string) => {\r\n    const form = new URLSearchParams();\r\n    form.append(\"username\", email.trim());\r\n    form.append(\"password\", password);\r\n\r\n    const { data } = await http.post<LoginResponse>(\"/auth/login\", form, {\r\n      headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\r\n    });\r\n\r\n    const mods = data.allowed_modules ?? [];\r\n    persistAuth(data.access_token, data.user, mods);\r\n  };\r\n\r\n  const logout = () => {\r\n    clearAuth();\r\n  };\r\n\r\n  useEffect(() => {\r\n    (async () => {\r\n      try {\r\n        if (localStorage.getItem(\"token\")) {\r\n          await refreshMe();\r\n        }\r\n      } catch {\r\n        clearAuth();\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    })();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []);\r\n\r\n  const value = useMemo(\r\n    () => ({\r\n      user,\r\n      token,\r\n      allowedModules,\r\n      loading,\r\n      isAuthenticated: Boolean(token && user),\r\n      login,\r\n      logout,\r\n      refreshMe,\r\n    }),\r\n    [user, token, allowedModules, loading]\r\n  );\r\n\r\n  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;\r\n}\r\n\r\nexport function useAuth() {\r\n  const ctx = useContext(AuthContext);\r\n  if (!ctx) throw new Error(\"useAuth must be used within AuthProvider\");\r\n  return ctx;\r\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}